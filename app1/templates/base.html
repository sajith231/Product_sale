<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Home{% endblock %}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    {% load static %}
    <link rel="stylesheet" href="{% static 'styles/base.css' %}">
</head>

<body>
    <!-- Header section -->
    <div class="header" style="position: fixed;width: 100%;top: 0;left: 0;right: 0;z-index: 999;">
        <div class="hamburger" id="hamburgerMenu">
            <span></span>
            <span></span>
            <span></span>
        </div>

        <div class="logo">Logo</div>

        <div class="location-dropdown" id="locationDropdown">
            <div class="location-trigger" onclick="toggleLocationDropdown()">
                <i class="fas fa-map-marker-alt location-icon"></i>
                <div class="location-content">
                    <p class="location-label">Location</p>
                    <p class="location-text">Mumbai, India</p>
                </div>
                <i class="fas fa-chevron-down dropdown-arrow"></i>
            </div>
            <div class="location-dropdown-menu">
                <div class="location-search">
                    <input type="text" placeholder="Search location..." id="locationSearch">
                </div>
                <div class="location-option selected" onclick="selectLocation(this, 'Karachi, Pak')">
                    <i class="fas fa-map-marker-alt"></i>Karachi, Pak
                </div>
                <div class="location-option" onclick="selectLocation(this, 'Mumbai, India')">
                    <i class="fas fa-map-marker-alt"></i>Mumbai, India
                </div>
                <div class="location-option" onclick="selectLocation(this, 'Dubai, UAE')">
                    <i class="fas fa-map-marker-alt"></i>Dubai, UAE
                </div>
            </div>
        </div>

        <div class="search-bar">
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" placeholder='What are you looking for?' class="pl-10">
            </div>
        </div>

        <div class="notification-wrapper">
            <i class="fas fa-bell notification-icon"></i>
            <span class="notification-badge">3</span>
        </div>

        <div class="header-actions">
            <a href="#" class="login-btn">
                <i class="fas fa-user"></i>
            </a>
        </div>
    </div>

    <!-- Side Menu -->
    <div id="sideMenu" class="side-menu">
        <div class="side-menu-header">
            <button id="closeSideMenuBtn" class="close-btn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="side-menu-content">
            <a href="{% url 'index' %}" class="side-menu-item"><i class="fas fa-home"></i><span>Home</span></a>
            <a href="{% url 'wishlist' %}" class="side-menu-item"><i class="fas fa-heart"></i><span>Wishlist</span></a>
            <a href="#" class="side-menu-item"><i class="fas fa-shopping-cart"></i><span>Cart</span></a>
            <a href="#" class="side-menu-item"><i class="fas fa-user"></i><span>Profile</span></a>
            <a href="{% url 'my_chats' %}" class="side-menu-item"><i class="fas fa-comments"></i><span>My Chats</span></a>
            <a href="#" class="side-menu-item"><i class="fas fa-cog"></i><span>Settings</span></a>
            <a href="#" class="side-menu-item"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a>
        </div>
    </div>

    <!-- Categories Section -->
    <div class="categories-wrapper">
        <div class="categories" id="categoriesContainer">
            <div class="category-item active">ALL CATEGORIES</div>
            <div class="category-item">
                <i class="fas fa-car"></i>
                Cars
            </div>
            <div class="category-item">
                <i class="fas fa-motorcycle"></i>
                Motorcycles
            </div>
            <div class="category-item">
                <i class="fas fa-mobile-alt"></i>
                Mobile Phones
            </div>
            <div class="category-item">
                <i class="fas fa-home"></i>
                For Sale: Houses & Apartments
            </div>
            <div class="category-item">
                <i class="fas fa-truck"></i>
                Commercial & Other Vehicles
            </div>
            <div class="category-item">
                <i class="fas fa-truck"></i>
                Commercial & Other Vehicles
            </div>
            <div class="category-item">
                <i class="fas fa-building"></i>
                For Rent: Houses & Apartments
            </div>
        </div>
    </div>

    <!-- Professional SELL button -->
    <button class="fixed-sell-btn" onclick="window.location.href='{% url 'select_category' %}'">
        <i class="fas fa-plus"></i>
        <span>Sell</span>
    </button>

    <!-- Categories Popup -->
    <div id="categoriesPopup" class="categories-popup">
        <div class="popup-header">
            <h3>Categories</h3>
            <button id="closePopupBtn" class="close-btn">
                <i class="fas fa-times" style="color: black;"></i>
            </button>
        </div>
        <div class="popup-content">
            <div class="category-section">
                <h4>Vehicles</h4>
                <ul>
                    <li>Cars</li>
                    <li>Motorcycles</li>
                    <li>Scooters</li>
                    <li>Spare Parts</li>
                    <li>Bicycles</li>
                </ul>
            </div>
            <div class="category-section">
                <h4>Electronics & Appliances</h4>
                <ul>
                    <li>Mobile Phones</li>
                    <li>Tablets</li>
                    <li>TVs, Video & Audio</li>
                    <li>Kitchen & Other Appliances</li>
                    <li>Computers & Laptops</li>
                    <li>Cameras & Lenses</li>
                </ul>
            </div>
            <div class="category-section">
                <h4>Home & Garden</h4>
                <ul>
                    <li>Furniture</li>
                    <li>Home Decor & Garden</li>
                    <li>Kids Furniture</li>
                    <li>Other Household Items</li>
                </ul>
            </div>
            <div class="category-section">
                <h4>Books, Sports & Hobbies</h4>
                <ul>
                    <li>Books</li>
                    <li>Gym & Fitness</li>
                    <li>Musical Instruments</li>
                    <li>Sports Equipment</li>
                    <li>Other Hobbies</li>
                </ul>
            </div>
            <div class="category-section">
                <h4>Properties</h4>
                <ul>
                    <li>For Sale: Houses & Apartments</li>
                    <li>For Rent: Houses & Apartments</li>
                    <li>Lands & Plots</li>
                    <li>For Rent: Shops & Offices</li>
                    <li>For Sale: Shops & Offices</li>
                    <li>PG & Guest Houses</li>
                </ul>
            </div>
            <div class="category-section">
                <h4>Jobs</h4>
                <ul>
                    <li>Data entry & Back office</li>
                    <li>Sales & Marketing</li>
                    <li>BPO & Telecaller</li>
                    <li>Driver</li>
                    <li>Office Assistant</li>
                    <li>Delivery & Collection</li>
                    <li>Teacher</li>
                    <li>Cook</li>
                    <li>Receptionist & Front office</li>
                    <li>Operator & Technician</li>
                    <li>IT Engineer & Developer</li>
                    <li>Hotel & Travel Executive</li>
                </ul>
            </div>
        </div>
    </div>

    {% block content %}{% endblock %}

    <script>
        // Categories functionality
        function toggleCategories() {
            const categoriesContainer = document.getElementById('categoriesContainer');
            categoriesContainer.style.display = categoriesContainer.style.display === 'none' ? 'flex' : 'none';
        }

        // Category selection
        document.addEventListener('DOMContentLoaded', function() {
            const categoryItems = document.querySelectorAll('.category-item');
            const categoriesContainer = document.getElementById('categoriesContainer');
            const scrollLeftIndicator = document.getElementById('scrollLeft');
            const scrollRightIndicator = document.getElementById('scrollRight');
            
            // Category click handler
            categoryItems.forEach(item => {
                item.addEventListener('click', function() {
                    categoryItems.forEach(cat => cat.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // Scroll indicators for mobile
            function updateScrollIndicators() {
                if (window.innerWidth <= 768) {
                    const scrollLeft = categoriesContainer.scrollLeft;
                    const maxScroll = categoriesContainer.scrollWidth - categoriesContainer.clientWidth;
                    
                    if (scrollLeft > 10) {
                        scrollLeftIndicator.classList.add('show');
                    } else {
                        scrollLeftIndicator.classList.remove('show');
                    }
                    
                    if (scrollLeft < maxScroll - 10) {
                        scrollRightIndicator.classList.add('show');
                    } else {
                        scrollRightIndicator.classList.remove('show');
                    }
                }
            }
            
            categoriesContainer.addEventListener('scroll', updateScrollIndicators);
            window.addEventListener('resize', updateScrollIndicators);
            
            // Initial check
            setTimeout(updateScrollIndicators, 100);
        });

        // Location dropdown functionality
        function toggleLocationDropdown() {
            const dropdown = document.getElementById('locationDropdown');
            dropdown.classList.toggle('active');
        }

        function selectLocation(element, location) {
            // Update the displayed location
            const locationText = document.querySelector('.location-text');
            locationText.textContent = location;

            // Update selected state
            document.querySelectorAll('.location-option').forEach(option => {
                option.classList.remove('selected');
            });
            element.classList.add('selected');

            // Close dropdown
            document.getElementById('locationDropdown').classList.remove('active');
        }

        // Categories popup functionality
        document.addEventListener('DOMContentLoaded', function () {
            const categoriesButton = document.querySelector('.category-item.active');
            const categoriesPopup = document.getElementById('categoriesPopup');
            const closePopupBtn = document.getElementById('closePopupBtn');

            if (categoriesButton) {
                categoriesButton.addEventListener('click', function () {
                    categoriesPopup.style.display = 'block';
                });
            }

            if (closePopupBtn) {
                closePopupBtn.addEventListener('click', function () {
                    categoriesPopup.style.display = 'none';
                });
            }

            // Close popup when clicking outside
            window.addEventListener('click', function (event) {
                if (event.target === categoriesPopup) {
                    categoriesPopup.style.display = 'none';
                }
            });
        });

        // Hamburger menu functionality - FIXED VERSION
        document.addEventListener('DOMContentLoaded', function() {
            const hamburger = document.getElementById('hamburgerMenu');
            const sideMenu = document.getElementById('sideMenu');
            const closeSideMenuBtn = document.getElementById('closeSideMenuBtn');

            function toggleSideMenu() {
                sideMenu.classList.toggle('active');
                hamburger.classList.toggle('open');
            }

            // Add event listeners
            if (hamburger) {
                hamburger.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleSideMenu();
                });
            }

            if (closeSideMenuBtn) {
                closeSideMenuBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleSideMenu();
                });
            }

            // Close menu when clicking outside
            document.addEventListener('click', function(event) {
                if (!hamburger.contains(event.target) && 
                    !sideMenu.contains(event.target) && 
                    sideMenu.classList.contains('active')) {
                    sideMenu.classList.remove('active');
                    hamburger.classList.remove('open');
                }
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function(event) {
                const dropdown = document.getElementById('locationDropdown');
                if (!dropdown.contains(event.target)) {
                    dropdown.classList.remove('active');
                }
            });
        });
    </script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB0dYlZgXcgzrzN4Pc6mvhmOyowj-QEFYk",
            authDomain: "e-commerce-66530.firebaseapp.com",
            projectId: "e-commerce-66530",
            storageBucket: "e-commerce-66530.firebasestorage.app",
            messagingSenderId: "295199322408",
            appId: "1:295199322408:web:f82d9ffa8656ab07d9a01d",
            measurementId: "G-HJ6T6PVD4F"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Manually set test users (replace later with logged-in user)
        const sender = "User1";    // You can replace with Django user variable
        const receiver = "User2";  // The other user

        // Send chat message
        function sendMessage() {
            const input = document.getElementById("chatInputField");
            const message = input.value.trim();
            if (message === "") return;

            db.collection("messages").add({
                from: sender,
                to: receiver,
                message: message,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });

            input.value = "";
        }

        // Realtime message fetching
        db.collection("messages")
            .orderBy("timestamp")
            .onSnapshot(snapshot => {
                const chatMessages = document.getElementById("chatMessages");
                chatMessages.innerHTML = "";

                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (
                        (data.from === sender && data.to === receiver) ||
                        (data.from === receiver && data.to === sender)
                    ) {
                        const msgDiv = document.createElement("div");
                        msgDiv.classList.add("message");
                        msgDiv.classList.add(data.from === sender ? "sent" : "received");
                        msgDiv.innerText = data.message;
                        chatMessages.appendChild(msgDiv);
                    }
                });

                chatMessages.scrollTop = chatMessages.scrollHeight;
            });

        // Chat open/close and enter key send
        function openChat() {
            document.getElementById("chatPanel").classList.add("open");
        }

        function closeChat() {
            document.getElementById("chatPanel").classList.remove("open");
        }

        function handleKey(event) {
            if (event.key === "Enter") {
                sendMessage();
            }
        }

        // Attach openChat to Send Message button
        document.addEventListener("DOMContentLoaded", () => {
            const chatButton = document.querySelector(".seller-actions .btn-primary");
            if (chatButton) {
                chatButton.addEventListener("click", openChat);
            }
        });
    </script>
</body>
</html>